version: '3'
services:
    portainer:
      image: portainer/portainer
      ports:
        - "9000:9000"
      command: -H unix:///var/run/docker.sock
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
        - ./infrastructure_components/portainer/data:/data
        - "/etc/timezone:/etc/timezone:ro"
        - "/etc/localtime:/etc/localtime:ro"
    #  logspout:
    #    image: gliderlabs/logspout:latest
    #    command: 'syslog://:5000'
    #    depends_on:
    #      - logstash
    #    volumes:
    #      - '/var/run/docker.sock:/var/run/docker.sock'
    filebeat:
      image: docker.elastic.co/beats/filebeat:6.5.4
      user: root
      depends_on:
        - elasticsearch
        - logstash
        - kibana
      volumes:
        - ./plotter/filebeat/filebeat.docker.yml:/usr/share/filebeat/filebeat.yml:ro
        - /var/lib/docker/containers:/var/lib/docker/containers:ro
        - /var/run/docker.sock:/var/run/docker.sock:ro
      environment:
        - output.elasticsearch.hosts=["elasticsearch:9200"]
        - strict.perms=false
    logstash:
      build:
        context: ./plotter/logstash
        dockerfile: Dockerfile
      image: logstash:latest
      ports:
        - "5044:5044"
        - "9600:9600"
      depends_on:
        - elasticsearch
        - kibana
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
        - "/etc/timezone:/etc/timezone:ro"
        - "/etc/localtime:/etc/localtime:ro"
    kibana:
      image: docker.elastic.co/kibana/kibana-oss:6.7.1
      depends_on:
        - elasticsearch
      ports:
        - '5601:5601'
      volumes:
        - ./plotter/kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml
        - /var/run/docker.sock:/var/run/docker.sock
        - "/etc/timezone:/etc/timezone:ro"
        - "/etc/localtime:/etc/localtime:ro"
    elasticsearch:
      image: docker.elastic.co/elasticsearch/elasticsearch-oss:6.7.1
      ports:
        - "9200:9200"
        - "9300:9300"
      volumes:
        - ./plotter/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
        - /var/run/docker.sock:/var/run/docker.sock
        - "/etc/timezone:/etc/timezone:ro"
        - "/etc/localtime:/etc/localtime:ro"
    redis:
      image: redis:latest
    sysctls:
        - fs.file-max=2097152
        - fs.nr_open=2097152
        - net.core.somaxconn=32768
        - net.ipv4.tcp_max_syn_backlog=16384
        - net.core.netdev_max_backlog=16384
        - net.ipv4.ip_local_port_range=1000 65535
        - net.core.rmem_default=262144
        - net.core.wmem_default=262144
        - net.core.rmem_max=16777216
        - net.core.wmem_max=16777216
        - net.core.optmem_max=16777216
        - net.ipv4.tcp_rmem=1024 4096 16777216
        - net.ipv4.tcp_wmem=1024 4096 16777216
        - net.ipv4.tcp_max_tw_buckets=1048576
        - net.ipv4.tcp_fin_timeout=15
      ports:
        - "6379:6379"
    redis-commander:
      image: rediscommander/redis-commander:latest
      environment:
        - REDIS_HOSTS=redis:redis:6379
      ports:
        - 8082:8081
    orchestrator:
      image: orchestrator:latest
      depends_on:
        - redis-commander
      deploy:
        replicas: 1
        #      resources:
        #        limits:
        #          cpus: "0.8"
        #          memory: 2000M
        restart_policy:
          condition: none
      environment:
        redis_server_hostname_key: 'redis'
        redis_server_port_key:  '6379'
        redis_log_keyname_key: 'orchestrator_load_test_events'
        # distribute_ports: 'true'
        # is_loopback_key: 'true'
        publisher_key_name: "publisher"
        publisher_hash_table_name: "publisher_hash_table"
        subscriber_key_name: "subscriber"
        subscriber_hash_table_name: "subscriber_hash_table"
        transformer_key_name: "transformer"
        transformer_hash_table_name: "transformer_hash_table"
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
        - "/etc/timezone:/etc/timezone:ro"
        - "/etc/localtime:/etc/localtime:ro"
    plotter:
      image: plotter:latest
      depends_on:
        - redis-commander
      deploy:
        replicas: 1
        #      resources:
        #        limits:
        #          cpus: "0.8"
        #          memory: 2000M
        restart_policy:
          condition: none
      environment:
        html_filename_key: '/opt/html_graph_storage/latency.html'
        redis_server_hostname_key: 'redis'
        redis_server_port_key:  '6379'
        redis_log_keyname_key: 'plotter_load_test_events'
        latency_redis_key: 'latency_results'
        latency_compute_start_key_name_key: 'start_time'
      volumes:
        - ./html_graph_storage:/opt/html_graph_storage
        - /var/run/docker.sock:/var/run/docker.sock
        - "/etc/timezone:/etc/timezone:ro"
        - "/etc/localtime:/etc/localtime:ro"
    displayer:
      image: displayer:latest
      ports:
        - "8888:8888"
      deploy:
        replicas: 1
        #      resources:
        #        limits:
        #          cpus: "0.8"
        #          memory: 2000M
        restart_policy:
          condition: none
      environment:
        html_filename_key: '/opt/html_graph_storage/latency.html'
      volumes:
        - ./html_graph_storage:/opt/html_graph_storage:ro
        - /var/run/docker.sock:/var/run/docker.sock
        - "/etc/timezone:/etc/timezone:ro"
        - "/etc/localtime:/etc/localtime:ro"